name: Claude PR Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, assigned]

jobs:
  claude-code-action:
    # ──────────── @claude が含まれるイベントだけ実行 ────────────
    if: |
      (github.event_name == 'issue_comment'            && contains(github.event.comment.body,        '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body,     '@claude')) ||
      (github.event_name == 'pull_request_review'      && contains(github.event.review.body,         '@claude')) ||
      (github.event_name == 'issues'                   && contains(github.event.issue.body,          '@claude'))
    runs-on: ubuntu-latest

    permissions:
      contents:       read   # ソース取得
      pull-requests:  read
      issues:         read
      id-token:       write  # OIDC → GITHUB_TOKEN 強化用（claude-code が自動取得）

    steps:
    # 1. リポジトリを取得
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    # 2. Claude CLI を最新版に固定（>= 1.0.8 なら OAuth 自前変換に完全対応）
    - name: Install latest claude-code CLI
      run: |
        npm install -g @anthropic-ai/claude-code@latest

    # 3. Claude Code Action を実行（OAuth フローは Action + CLI に任せる）
    - name: Run Claude Code Action
      uses: grll/claude-code-action@beta
      with:
        use_oauth: true                      # OAuth モード
        claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
        model: claude-opus-4-20250514
        timeout_minutes: 60
        custom_instructions: |
          特別な理由がない限り日本語で会話してください
