# æ—¢å­˜éƒ¨åˆ†ã¯ãã®ã¾ã¾ã€‚å¤‰æ›´ãƒ»è¿½åŠ ã¯ã‚³ãƒ¡ãƒ³ãƒˆä»˜ãã§ç¤ºã—ã¾ã™
steps:
  - name: Checkout repository
    uses: actions/checkout@v4
    with:
      fetch-depth: 1

  # ğŸ”¸ è¿½åŠ ï¼†å¤‰æ›´: access_token ã¨ expires_at ã®ä¸¡æ–¹ã‚’å‡ºåŠ›
  - name: Refresh Claude token
    id: auth
    env:
      REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
    run: |
      sudo apt-get -y update && sudo apt-get -y install jq
      JSON=$(curl -sS -X POST https://api.anthropic.com/oauth/token \
        -d grant_type=refresh_token \
        -d refresh_token=${REFRESH_TOKEN} \
        -d client_id=gh-action \
        -d client_secret=unused)

      # --- access_token ---
      echo "::add-mask::$(echo "$JSON" | jq -r .access_token)"
      echo "token=$(echo "$JSON" | jq -r .access_token)" >> $GITHUB_OUTPUT

      # --- expires_at ---
      #   ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« expires_at ãŒç„¡ã„å ´åˆã¯ expires_in ã‹ã‚‰ç®—å‡º
      exp=$(echo "$JSON" | jq -r '.expires_at // empty')
      if [ -z "$exp" ]; then
        exp_in=$(echo "$JSON" | jq -r '.expires_in // 1800')   # ç§’
        exp=$(($(date +%s) + exp_in - 60))                     # 60ç§’ãƒãƒƒãƒ•ã‚¡
      fi
      echo "expires=$exp" >> $GITHUB_OUTPUT

  - name: Run Claude PR Action
    uses: grll/claude-code-action@beta
    with:
      use_oauth: true
      claude_access_token: ${{ steps.auth.outputs.token }}
      claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
      # ğŸ”¸ è¿½åŠ : å‹•çš„ã«ç®—å‡ºã—ãŸ expires_at ã‚’æ¸¡ã™
      claude_expires_at: ${{ steps.auth.outputs.expires }}
      model: "claude-opus-4-20250514"
      timeout_minutes: "60"
